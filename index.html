<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô - Task Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Prompt -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Apply Prompt font to the entire body */
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #f0fdfa; /* Light Cyan Background */
        }
        /* Custom scrollbar styling for better look */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #0d9488; /* Teal-600 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #ccfbf1; /* Cyan-100 */
        }
        /* Force Chart.js canvas to adapt to container */
        .chart-container {
            height: 400px;
            width: 100%;
        }
        /* Animation for loading state */
        .loading-ring {
            display: inline-block;
            width: 80px;
            height: 80px;
        }
        .loading-ring:after {
            content: " ";
            display: block;
            width: 64px;
            height: 64px;
            margin: 8px;
            border-radius: 50%;
            border: 6px solid #0d9488;
            border-color: #0d9488 transparent #0d9488 transparent;
            animation: loading-ring-anim 1.2s linear infinite;
        }
        @keyframes loading-ring-anim {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen antialiased flex flex-col">

    <!-- Header / Navigation -->
    <header class="bg-teal-600 shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-white">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô</h1>
            <div class="flex space-x-2">
                <button onclick="changeMenu('tasks')" id="menu-tasks" class="menu-btn px-4 py-2 text-sm font-medium rounded-lg text-teal-100 hover:bg-teal-700 transition duration-150 bg-teal-700">‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô</button>
                <button onclick="changeMenu('personnel')" id="menu-personnel" class="menu-btn px-4 py-2 text-sm font-medium rounded-lg text-teal-100 hover:bg-teal-700 transition duration-150">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</button>
                <button onclick="changeMenu('tracking')" id="menu-tracking" class="menu-btn px-4 py-2 text-sm font-medium rounded-lg text-teal-100 hover:bg-teal-700 transition duration-150">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô</button>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">

        <!-- API URL Setup Warning/Input -->
        <div id="api-setup-card" class="mb-6 p-4 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-lg hidden">
            <p class="font-bold mb-2">üö® ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API!</p>
            <p class="text-sm mb-4">‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Google Apps Script Web App (‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy ‡πÑ‡∏ü‡∏•‡πå `Code.gs`) ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ:</p>
            <input type="text" id="api-url-input" placeholder="https://script.google.com/macros/s/AKfycbyN2pscleCHOkm6TKjSU2oDX3-tR1pVBatL9b_ZyRk45_2G0RFnZCwBTU7Hq5DXn9E1-w/exec" class="w-full p-2 border border-red-300 rounded-md text-gray-800 focus:ring-red-500 focus:border-red-500">
            <button onclick="setApiUrl()" class="mt-3 px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition duration-150">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å URL API</button>
        </div>

        <!-- Global Status/Message Container -->
        <div id="status-message" class="fixed bottom-5 right-5 z-50"></div>

        <!-- Loading Indicator -->
        <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50 hidden">
            <div class="flex flex-col items-center">
                <div class="loading-ring"></div>
                <p class="mt-4 text-teal-600 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
        </div>

        <!-- 1. Menu: Personnel (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö) -->
        <section id="personnel-menu" class="menu-section hidden">
            <h2 class="text-3xl font-bold text-teal-700 mb-6">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</h2>
            <div class="bg-white p-6 rounded-xl shadow-2xl border border-teal-200">
                <form id="add-personnel-form" class="space-y-4">
                    <div>
                        <label for="p-name" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠</label>
                        <input type="text" id="p-name" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-teal-500 focus:border-teal-500 transition">
                    </div>
                    <div>
                        <label for="p-surname" class="block text-sm font-medium text-gray-700">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                        <input type="text" id="p-surname" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-teal-500 focus:border-teal-500 transition">
                    </div>
                    <div>
                        <label for="p-position" class="block text-sm font-medium text-gray-700">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                        <input type="text" id="p-position" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-teal-500 focus:border-teal-500 transition">
                    </div>
                    <button type="submit" class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition duration-150">
                        <i data-lucide="user-plus" class="w-5 h-5 mr-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö
                    </button>
                </form>
            </div>

            <div class="mt-10">
                <h3 class="text-2xl font-semibold text-teal-700 mb-4">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                <div id="personnel-list" class="bg-white p-4 rounded-xl shadow-inner border border-teal-100 space-y-2 max-h-96 overflow-y-auto custom-scrollbar">
                    <p class="text-center text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...</p>
                </div>
            </div>
        </section>

        <!-- 2. Menu: Tasks (‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô) -->
        <section id="tasks-menu" class="menu-section">
            <h2 class="text-3xl font-bold text-teal-700 mb-6">‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</h2>

            <!-- Form to Add/Edit Task -->
            <div class="bg-white p-6 rounded-xl shadow-2xl border border-teal-200 mb-8">
                <h3 class="text-xl font-semibold text-teal-700 mb-4" id="task-form-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
                <form id="add-task-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <input type="hidden" id="task-id">
                    <div>
                        <label for="t-project" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</label>
                        <input type="text" id="t-project" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-teal-500 focus:border-teal-500 transition">
                    </div>
                    <div>
                        <label for="t-activity" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏¢‡πà‡∏≠‡∏¢</label>
                        <input type="text" id="t-activity" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-teal-500 focus:border-teal-500 transition">
                    </div>
                    <div>
                        <label for="t-assignees" class="block text-sm font-medium text-gray-700">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô)</label>
                        <select id="t-assignees" multiple size="5" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-teal-500 focus:border-teal-500 transition custom-scrollbar text-sm">
                            <!-- Options populated by JS -->
                        </select>
                        <p class="text-xs text-gray-500 mt-1">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Ctrl/Cmd ‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</p>
                    </div>
                    <div>
                        <label for="t-due-date" class="block text-sm font-medium text-gray-700">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                        <input type="date" id="t-due-date" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-teal-500 focus:border-teal-500 transition">
                    </div>
                    <div class="md:col-span-2">
                        <label for="t-status" class="block text-sm font-medium text-gray-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô</label>
                        <select id="t-status" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-teal-500 focus:border-teal-500 transition">
                            <option value="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô</option>
                            <option value="‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô">‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô</option>
                            <option value="‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</option>
                            <option value="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô</option>
                        </select>
                    </div>

                    <div class="md:col-span-2 flex space-x-4">
                        <button type="submit" id="task-submit-btn" class="flex-1 flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition duration-150">
                            <i data-lucide="send" class="w-5 h-5 mr-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô
                        </button>
                        <button type="button" onclick="resetTaskForm()" class="px-4 py-3 border border-gray-300 rounded-lg shadow-md text-sm font-medium text-gray-700 bg-gray-50 hover:bg-gray-100 transition duration-150" id="task-cancel-btn" style="display: none;">
                            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                        </button>
                    </div>
                </form>
            </div>

            <!-- Task List -->
            <h3 class="text-2xl font-semibold text-teal-700 mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
            <div class="overflow-x-auto bg-white p-4 rounded-xl shadow-inner border border-teal-100">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-teal-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-teal-700 uppercase tracking-wider">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£/‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-teal-700 uppercase tracking-wider">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-teal-700 uppercase tracking-wider">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-teal-700 uppercase tracking-wider">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-teal-700 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="task-table-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="5" class="p-4 text-center text-gray-500">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- 3. Menu: Tracking (‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô) -->
        <section id="tracking-menu" class="menu-section hidden">
            <h2 class="text-3xl font-bold text-teal-700 mb-6">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô</h2>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- 3.1 Graph: Project Comparison -->
                <div class="bg-white p-6 rounded-xl shadow-2xl border border-teal-200">
                    <h3 class="text-xl font-semibold text-teal-700 mb-4">3.1 ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h3>
                    <div class="chart-container">
                        <canvas id="project-completion-chart"></canvas>
                    </div>
                    <p id="project-chart-status" class="text-center text-sm text-gray-500 mt-2 hidden">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</p>
                </div>

                <!-- 3.2 Graph: Individual Comparison -->
                <div class="bg-white p-6 rounded-xl shadow-2xl border border-teal-200">
                    <h3 class="text-xl font-semibold text-teal-700 mb-4">3.2 ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h3>
                    <div class="chart-container">
                        <canvas id="individual-completion-chart"></canvas>
                    </div>
                    <p id="individual-chart-status" class="text-center text-sm text-gray-500 mt-2 hidden">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</p>
                </div>
            </div>
        </section>

    </main>

    <!-- Modal for Task Details / Alert Message Box -->
    <div id="alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-[100]">
        <div class="bg-white p-6 rounded-xl shadow-3xl max-w-sm w-full border-t-4 border-yellow-500">
            <h3 class="text-xl font-bold text-yellow-700 mb-4 flex items-center"><i data-lucide="bell" class="w-6 h-6 mr-2"></i> ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏á‡∏≤‡∏ô</h3>
            <div id="alert-content" class="text-gray-700 text-sm space-y-2 max-h-60 overflow-y-auto custom-scrollbar p-1">
                <!-- Alert messages will be inserted here -->
            </div>
            <button onclick="document.getElementById('alert-modal').classList.add('hidden')" class="mt-4 w-full py-2 bg-yellow-500 text-white font-medium rounded-lg hover:bg-yellow-600 transition">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</button>
        </div>
    </div>


    <script>
        // --- Configuration & Global State ---
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î URL ‡∏Ç‡∏≠‡∏á Google Apps Script Web App ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡πâ‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        const DEFAULT_APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzBCFsqRpVhQrZKEwuu5iW9PluzN2RVNU6ajzNm-BWDSArowUHvVTQM2RKLaCVYRerZEQ/exec";
        let APPS_SCRIPT_URL = localStorage.getItem('appsScriptUrl') || DEFAULT_APPS_SCRIPT_URL;

        const SHEET_NAMES = {
            PERSONNEL: 'Personnel',
            TASKS: 'Tasks'
        };

        let currentMenu = 'tasks';
        let personnelData = [];
        let taskData = [];

        let projectChart = null;
        let individualChart = null;

        // Utility: Show/Hide Loading Overlay
        function toggleLoading(show) {
            document.getElementById('loading-overlay').classList.toggle('hidden', !show);
        }

        // Utility: Show Status Message (like alert, but non-blocking)
        function showStatus(message, type = 'success') {
            const container = document.getElementById('status-message');
            const color = type === 'success' ? 'bg-teal-500' : (type === 'error' ? 'bg-red-500' : 'bg-yellow-500');
            const icon = type === 'success' ? 'check-circle' : (type === 'error' ? 'x-octagon' : 'alert-triangle');

            const statusEl = document.createElement('div');
            statusEl.className = `${color} text-white p-3 rounded-xl shadow-lg mb-3 flex items-center opacity-0 transition-opacity duration-300`;
            statusEl.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 mr-2"></i> ${message}`;
            
            container.appendChild(statusEl);
            lucide.createIcons(); // Initialize icons for the new element

            // Fade in
            setTimeout(() => statusEl.classList.remove('opacity-0'), 10);
            
            // Fade out and remove
            setTimeout(() => {
                statusEl.classList.add('opacity-0');
                setTimeout(() => statusEl.remove(), 300);
            }, 5000);
        }

        // --- API & Data Handling Functions ---

        // Exponential backoff retry function
        async function fetchWithRetry(url, options = {}, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    if (i === retries - 1) {
                        throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay * (2 ** i)));
                }
            }
        }

        async function fetchData(action, params = {}) {
            if (!APPS_SCRIPT_URL) {
                showApiSetupWarning();
                return null;
            }
            toggleLoading(true);
            const url = new URL(APPS_SCRIPT_URL);
            url.searchParams.append('action', action);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));

            console.log('Attempting GET fetch to:', url.toString()); // DEBUG LOG: ‡πÅ‡∏™‡∏î‡∏á URL ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ

            try {
                const result = await fetchWithRetry(url.toString());
                toggleLoading(false);
                if (result.status === 'success') {
                    return result.data;
                } else {
                    showStatus(`Error fetching data for ${action}: ${result.error || 'Unknown error'}`, 'error');
                    return null;
                }
            } catch (error) {
                toggleLoading(false);
                showStatus(`Failed to connect to API: ${error.message}`, 'error');
                console.error("API Call Error:", error);
                return null;
            }
        }

        async function postData(action, payload) {
            if (!APPS_SCRIPT_URL) {
                showApiSetupWarning();
                return null;
            }
            toggleLoading(true);
            const url = APPS_SCRIPT_URL;

            console.log('Attempting POST fetch to:', url, 'with action:', action); // DEBUG LOG: ‡πÅ‡∏™‡∏î‡∏á URL ‡πÅ‡∏•‡∏∞ Action ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ
            
            try {
                const result = await fetchWithRetry(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action, ...payload }),
                });

                toggleLoading(false);

                if (result.status === 'success') {
                    showStatus(result.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    await refreshAllData(); // Refresh all data after successful POST
                    return true;
                } else {
                    showStatus(`‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${result.error}`, 'error');
                    return false;
                }
            } catch (error) {
                toggleLoading(false);
                showStatus(`‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`, 'error');
                console.error("API POST Error:", error);
                return false;
            }
        }

        // --- Core Data Refresh ---

        async function refreshAllData() {
            // Fetch Personnel
            const personnelResult = await fetchData('getPersonnel');
            if (personnelResult) {
                personnelData = personnelResult.map(p => ({
                    id: p[0],
                    name: p[1],
                    surname: p[2],
                    position: p[3]
                }));
                renderPersonnelList();
                populateAssigneeSelect();
            }

            // Fetch Tasks
            const tasksResult = await fetchData('getTasks');
            if (tasksResult) {
                // Map the raw sheet data to structured task objects
                taskData = tasksResult.map(t => ({
                    id: t[0],
                    projectName: t[1],
                    subActivity: t[2],
                    assignees: t[3] ? t[3].split(',').map(s => s.trim()) : [], // Split comma-separated string back to array
                    dueDate: t[4],
                    status: t[5],
                    createdAt: t[6] // Not used in UI but good for data integrity
                }));
                renderTaskTable();
                checkDueDates();
                updateTrackingCharts();
            }
        }

        // --- Menu Switching ---

        function changeMenu(menu) {
            currentMenu = menu;
            document.querySelectorAll('.menu-section').forEach(section => section.classList.add('hidden'));
            document.getElementById(`${menu}-menu`).classList.remove('hidden');

            document.querySelectorAll('.menu-btn').forEach(btn => {
                btn.classList.remove('bg-teal-700');
                if (btn.id === `menu-${menu}`) {
                    btn.classList.add('bg-teal-700');
                }
            });

            // Re-render charts when switching to tracking menu to prevent rendering issues
            if (menu === 'tracking') {
                updateTrackingCharts(true);
            }
        }

        // --- 1. Personnel Logic ---

        function renderPersonnelList() {
            const listEl = document.getElementById('personnel-list');
            listEl.innerHTML = '';
            if (personnelData.length === 0) {
                listEl.innerHTML = '<p class="text-center text-gray-500 p-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>';
                return;
            }

            personnelData.forEach(p => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-3 bg-teal-50 rounded-lg shadow-sm border border-teal-200';
                item.innerHTML = `
                    <div>
                        <p class="font-medium text-teal-800">${p.name} ${p.surname}</p>
                        <p class="text-xs text-gray-600">${p.position}</p>
                    </div>
                    <i data-lucide="check-circle" class="w-5 h-5 text-teal-500"></i>
                `;
                listEl.appendChild(item);
            });
            lucide.createIcons();
        }

        document.getElementById('add-personnel-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('p-name').value;
            const surname = document.getElementById('p-surname').value;
            const position = document.getElementById('p-position').value;

            const success = await postData('addPersonnel', {
                name, surname, position
            });

            if (success) {
                e.target.reset();
            }
        });

        // --- 2. Tasks Logic ---

        function populateAssigneeSelect() {
            const selectEl = document.getElementById('t-assignees');
            selectEl.innerHTML = '';

            if (personnelData.length === 0) {
                selectEl.innerHTML = '<option disabled>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö. ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô</option>';
                return;
            }

            personnelData.forEach(p => {
                const option = document.createElement('option');
                option.value = `${p.name} ${p.surname}`;
                option.textContent = `${p.name} ${p.surname} (${p.position})`;
                selectEl.appendChild(option);
            });
        }

        function getStatusBadge(status) {
            let color = '';
            switch (status) {
                case '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß':
                    color = 'bg-green-500';
                    break;
                case '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô':
                    color = 'bg-yellow-500';
                    break;
                case '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô':
                    color = 'bg-red-500';
                    break;
                case '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô':
                default:
                    color = 'bg-gray-500';
                    break;
            }
            return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${color} text-white">${status}</span>`;
        }

        function renderTaskTable() {
            const tbody = document.getElementById('task-table-body');
            tbody.innerHTML = '';

            if (taskData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</td></tr>';
                return;
            }

            taskData.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate)); // Sort by due date

            taskData.forEach(t => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-teal-50 transition duration-150';

                const assigneesHtml = t.assignees.map(a => `<span class="text-xs bg-cyan-100 text-cyan-800 rounded-full px-2 py-0.5">${a.split(' ')[0]}</span>`).join(' ');

                tr.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-sm font-medium text-teal-800">${t.projectName}</div>
                        <div class="text-xs text-gray-500">${t.subActivity}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-normal">${assigneesHtml}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatDate(t.dueDate)}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${getStatusBadge(t.status)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="editTask('${t.id}')" class="text-teal-600 hover:text-teal-900 mx-1 p-2 rounded-full hover:bg-teal-100 transition duration-150">
                            <i data-lucide="square-pen" class="w-4 h-4"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            try {
                return new Date(dateString).toLocaleDateString('th-TH', options);
            } catch {
                return dateString; // Return original if invalid
            }
        }

        function editTask(taskId) {
            const task = taskData.find(t => t.id === taskId);
            if (!task) return;

            // Fill the form
            document.getElementById('task-id').value = task.id;
            document.getElementById('t-project').value = task.projectName;
            document.getElementById('t-activity').value = task.subActivity;
            document.getElementById('t-due-date').value = task.dueDate;
            document.getElementById('t-status').value = task.status;

            // Select multiple assignees
            const assigneesSelect = document.getElementById('t-assignees');
            Array.from(assigneesSelect.options).forEach(option => {
                option.selected = task.assignees.includes(option.value);
            });

            document.getElementById('task-form-title').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô';
            document.getElementById('task-submit-btn').innerHTML = '<i data-lucide="save" class="w-5 h-5 mr-2"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô';
            document.getElementById('task-cancel-btn').style.display = 'inline-block';
            lucide.createIcons();

            // Scroll to the form
            document.getElementById('tasks-menu').scrollIntoView({ behavior: 'smooth' });
        }

        function resetTaskForm() {
            document.getElementById('add-task-form').reset();
            document.getElementById('task-id').value = '';
            document.getElementById('task-form-title').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('task-submit-btn').innerHTML = '<i data-lucide="send" class="w-5 h-5 mr-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô';
            document.getElementById('task-cancel-btn').style.display = 'none';
            lucide.createIcons();
        }

        document.getElementById('add-task-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const taskId = document.getElementById('task-id').value;
            const projectName = document.getElementById('t-project').value;
            const subActivity = document.getElementById('t-activity').value;
            const dueDate = document.getElementById('t-due-date').value;
            const status = document.getElementById('t-status').value;

            // Get selected assignees (array of full names)
            const assigneesSelect = document.getElementById('t-assignees');
            const selectedAssignees = Array.from(assigneesSelect.options)
                .filter(option => option.selected)
                .map(option => option.value);

            // Convert array to comma-separated string for Google Sheet
            const assigneesString = selectedAssignees.join(', ');

            const payload = {
                projectName, subActivity, assignees: assigneesString, dueDate, status
            };

            let success = false;
            if (taskId) {
                // Update existing task
                payload.id = taskId;
                success = await postData('updateTask', payload);
            } else {
                // Add new task
                success = await postData('addTask', payload);
            }

            if (success) {
                resetTaskForm();
            }
        });

        // --- Due Date Alert Logic (Client-side) ---

        function checkDueDates() {
            const today = new Date();
            const alerts = [];

            taskData.forEach(task => {
                if (task.status === '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß' || task.status === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô') {
                    return; // Skip completed or cancelled tasks
                }

                const due = new Date(task.dueDate);
                const diffTime = due.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays >= 0 && diffDays <= 5) {
                    alerts.push({
                        ...task,
                        daysRemaining: diffDays
                    });
                } else if (diffDays < 0) {
                    alerts.push({
                        ...task,
                        daysRemaining: diffDays,
                        isOverdue: true
                    });
                }
            });

            if (alerts.length > 0) {
                renderAlertModal(alerts);
            }
        }

        function renderAlertModal(alerts) {
            const contentEl = document.getElementById('alert-content');
            contentEl.innerHTML = '';

            alerts.forEach(a => {
                const dayText = a.isOverdue ? `<span class="font-bold text-red-600">‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ${Math.abs(a.daysRemaining)} ‡∏ß‡∏±‡∏ô</span>` : `<span class="font-bold text-yellow-600">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${a.daysRemaining} ‡∏ß‡∏±‡∏ô</span>`;
                
                const alertItem = document.createElement('div');
                alertItem.className = 'p-3 border-b border-yellow-100 last:border-b-0 bg-yellow-50 rounded-md';
                alertItem.innerHTML = `
                    <p class="text-sm font-semibold text-gray-800">${a.projectName}: ${a.subActivity}</p>
                    <p class="text-xs text-gray-600 mt-1">‡∏Å‡∏≥‡∏´‡∏ô‡∏î: ${formatDate(a.dueDate)} | ${dayText}</p>
                    <p class="text-xs text-gray-500">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö: ${a.assignees.join(', ')}</p>
                `;
                contentEl.appendChild(alertItem);
            });
            document.getElementById('alert-modal').classList.remove('hidden');
        }


        // --- 3. Tracking Logic (Charts) ---

        function prepareProjectData(tasks) {
            const projectStats = {};

            tasks.forEach(t => {
                const project = t.projectName;
                if (!projectStats[project]) {
                    projectStats[project] = { total: 0, completed: 0 };
                }
                projectStats[project].total++;
                if (t.status === '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß') {
                    projectStats[project].completed++;
                }
            });

            const labels = Object.keys(projectStats);
            const totalData = labels.map(p => projectStats[p].total);
            const completedData = labels.map(p => projectStats[p].completed);

            return { labels, totalData, completedData };
        }

        function prepareIndividualData(tasks) {
            const individualStats = {};

            tasks.forEach(t => {
                t.assignees.forEach(assignee => {
                    if (!individualStats[assignee]) {
                        individualStats[assignee] = { total: 0, completed: 0 };
                    }
                    individualStats[assignee].total++;
                    if (t.status === '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß') {
                        individualStats[assignee].completed++;
                    }
                });
            });

            const labels = Object.keys(individualStats);
            const totalData = labels.map(p => individualStats[p].total);
            const completedData = labels.map(p => individualStats[p].completed);

            return { labels, totalData, completedData };
        }

        function createBarChart(ctx, data, chartTitle) {
            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: '‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
                            data: data.totalData,
                            backgroundColor: '#20c997', // Teal-400
                            borderColor: '#10b981',
                            borderWidth: 1,
                        },
                        {
                            label: '‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß',
                            data: data.completedData,
                            backgroundColor: '#06b6d4', // Cyan-500
                            borderColor: '#0891b2',
                            borderWidth: 1,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { font: { family: 'Prompt' } } },
                        title: { display: false, text: chartTitle, font: { family: 'Prompt' } }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô', font: { family: 'Prompt' } } },
                        x: { ticks: { font: { family: 'Prompt' } } }
                    }
                }
            });
        }

        function updateTrackingCharts(forceRender = false) {
            // 3.1 Project Completion Chart
            const projectData = prepareProjectData(taskData);
            const projectCtx = document.getElementById('project-completion-chart');

            if (projectData.labels.length === 0) {
                document.getElementById('project-chart-status').classList.remove('hidden');
                projectCtx.style.display = 'none';
            } else {
                document.getElementById('project-chart-status').classList.add('hidden');
                projectCtx.style.display = 'block';

                if (projectChart && !forceRender) {
                    projectChart.data.labels = projectData.labels;
                    projectChart.data.datasets[0].data = projectData.totalData;
                    projectChart.data.datasets[1].data = projectData.completedData;
                    projectChart.update();
                } else {
                    if (projectChart) projectChart.destroy();
                    projectChart = createBarChart(projectCtx, projectData, '‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£');
                }
            }


            // 3.2 Individual Completion Chart
            const individualData = prepareIndividualData(taskData);
            const individualCtx = document.getElementById('individual-completion-chart');

            if (individualData.labels.length === 0) {
                document.getElementById('individual-chart-status').classList.remove('hidden');
                individualCtx.style.display = 'none';
            } else {
                document.getElementById('individual-chart-status').classList.add('hidden');
                individualCtx.style.display = 'block';

                if (individualChart && !forceRender) {
                    individualChart.data.labels = individualData.labels;
                    individualChart.data.datasets[0].data = individualData.totalData;
                    individualChart.data.datasets[1].data = individualData.completedData;
                    individualChart.update();
                } else {
                    if (individualChart) individualChart.destroy();
                    individualChart = createBarChart(individualCtx, individualData, '‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•');
                }
            }
        }

        // --- API Setup & Initialization ---

        function showApiSetupWarning() {
            // ‡πÅ‡∏™‡∏î‡∏á URL ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á Input ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ
            document.getElementById('api-url-input').value = APPS_SCRIPT_URL || '';
            document.getElementById('api-setup-card').classList.remove('hidden');
        }

        function setApiUrl() {
            const urlInput = document.getElementById('api-url-input').value.trim();
            if (urlInput && urlInput.startsWith('http')) {
                APPS_SCRIPT_URL = urlInput;
                localStorage.setItem('appsScriptUrl', APPS_SCRIPT_URL);
                document.getElementById('api-setup-card').classList.add('hidden');
                showStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å URL API ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'success');
                refreshAllData();
            } else {
                showStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Google Apps Script Web App ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
            }
        }

        // --- Initialization ---

        window.onload = () => {
            // Initialize Lucide icons
            lucide.createIcons();
            
            // Check API URL on load
            if (!APPS_SCRIPT_URL) {
                // ‡∏´‡∏≤‡∏Å URL ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á ‡πÜ (‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏µ DEFAULT)
                showApiSetupWarning();
            } else {
                // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ URL ‡πÅ‡∏•‡πâ‡∏ß (‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏´‡∏£‡∏∑‡∏≠ localStorage) ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                document.getElementById('api-setup-card').classList.add('hidden');
                refreshAllData();
            }
            
            // Set initial menu display
            changeMenu('tasks');
        };
    </script>

</body>
</html>
